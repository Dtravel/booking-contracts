version: 2.1
orbs:
  node: circleci/node@5.0.2
commands:
  setup-environment:
    description: "Setup requirements"
    steps:
      - run:
          name: "Setup environment"
          command: |
            sudo apt update
            sudo apt install openjdk-11-jre-headless
  install-engine:
    description: "Install Sonarqube scanner"
    parameters:
      engine_version:
        type: string
        default: "4.2.0.1873"
    steps:
      - run:
          name: "Install Sonarqube scanner"
          command: |
            wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-<< parameters.engine_version >>.zip
            unzip sonar-scanner-cli-<< parameters.engine_version >>.zip
  code-analysis:
    steps:
      - run:
          name: "Sonarqube scanner"
          command: |
            sonar-scanner \
              -Dsonar.projectKey=dTravel_$CIRCLE_PROJECT_REPONAME\
              -Dsonar.sources=. \
              -Dsonar.host.url=$HOST_URL \
              -Dsonar.login=$SONAR_LOGIN \
              -Dsonar.javascript.lcov.reportPaths=./coverage/lcov.info \
              -Dsonar.coverage.exclusions='src/main.ts,src/common/**/*.*,test/*.*,src/**/*.spec.ts'
jobs:
  run-test:
    executor:
      name: node/default
      tag: '16.15.1'
    steps:
      - checkout
      - node/install-packages:
          check-cache: always
          pkg-manager: yarn-berry
          with-cache: true
      - run:
          name: Test contracts
          command: npx hardhat test
  run-coverage:
    executor:
      name: node/default
      tag: '16.15.1'
    steps:
      - checkout
      - node/install-packages:
          check-cache: always
          pkg-manager: yarn-berry
          with-cache: true
      - run:
          name: Test coverage
          command: npx hardhat clean && npx hardhat coverage
      - store_artifacts:
          path: reports/coverage
  run-sonar:
    executor: docker-executor
    steps:
      - setup-environment
      - install-engine
      - code-analysis
workflows:
  test-and-coverage:
    jobs:
      - run-test
      - run-coverage:
          requires:
            - run-test
      - run-sonar:
          context:
            - ecr-dev
          requires:
            - run-coverage